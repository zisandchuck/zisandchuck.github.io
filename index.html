<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roblox 卡密生成系统（Step1）</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: Arial, Helvetica, sans-serif; }
    body{
      background:#121212; color:#fff; min-height:100vh; padding:20px;
      display:flex; flex-direction:column; align-items:center; gap:20px;
    }
    .container{
      width:100%; max-width:500px; background:#1e1e1e; padding:25px;
      border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.3);
    }
    h1{ color:#64b5f6; text-align:center; margin-bottom:20px; }
    .input-group{ margin-bottom:15px; }
    label{ display:block; margin-bottom:5px; color:#bbb; }
    input{
      width:100%; padding:10px; background:#2d2d2d; border:1px solid #3d3d3d;
      border-radius:5px; color:#fff; font-size:16px;
    }
    input:focus{ outline:none; border-color:#64b5f6; }
    input[readonly]{ background:#333; cursor:not-allowed; }
    button{
      width:100%; padding:12px; background:#2196f3; border:none; border-radius:5px;
      color:#fff; font-size:16px; cursor:pointer; transition:.2s;
      margin-top:10px;
    }
    button:disabled{ background:#666; cursor:not-allowed; }
    button:hover:not(:disabled){ background:#1976d2; }
    .status-box{
      margin-top:15px; padding:15px; border-radius:5px; background:#2d2d2d;
      min-height:60px; white-space:pre-wrap;
      border-left:4px solid #2196f3;
    }
    .success{ border-left-color:#4caf50; }
    .error{ border-left-color:#f44336; }
    .info{ border-left-color:#2196f3; }
    .step-indicator{
      display:flex; justify-content:center; margin-bottom:15px;
    }
    .step-item{
      width:30px; height:30px; border-radius:50%; background:#3d3d3d;
      display:flex; align-items:center; justify-content:center; font-weight:bold;
    }
    .step-item.completed{ background:#4caf50; }
    .step-item.active{ background:#2196f3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>卡密生成系统（仅Step1）</h1>

    <div class="step-indicator">
      <div id="step1-indicator" class="step-item active">1</div>
    </div>

    <div class="input-group">
      <label for="robloxId">Roblox ID</label>
      <input id="robloxId" placeholder="输入你的Roblox用户ID" />
    </div>

    <div class="input-group">
      <label for="hwid">设备ID (HWID)</label>
      <input id="hwid" readonly />
    </div>

    <button id="step1-btn" disabled>Step1：完成LootLabs广告</button>
    <button id="generate-btn" disabled>生成卡密</button>

    <div class="input-group" style="margin-top:20px;">
      <label for="key">验证卡密</label>
      <input id="key" placeholder="输入生成的卡密" />
      <button id="verify-btn">验证卡密</button>
    </div>

    <div id="status" class="status-box info">系统就绪，请先填写Roblox ID</div>
  </div>

  <script>
    // 改成你的 Worker 域名
    const WORKER_URL = "https://r.check868.workers.dev";

    // 你的 LootLabs 链接（保留你自己的）
    const LOOTLABS_URL = "https://lootdest.org/s?Li5EAgHB";

    const robloxIdInput = document.getElementById("robloxId");
    const hwidInput = document.getElementById("hwid");
    const statusBox = document.getElementById("status");
    const step1Btn = document.getElementById("step1-btn");
    const generateBtn = document.getElementById("generate-btn");
    const verifyBtn = document.getElementById("verify-btn");
    const step1Indicator = document.getElementById("step1-indicator");

    function showStatus(msg, type="info"){
      statusBox.textContent = msg;
      statusBox.className = `status-box ${type}`;
    }

    function initHWID(){
      let hwid = localStorage.getItem("roblox_fixed_hwid");
      if(!hwid){
        hwid = `hwid_${Math.random().toString(36).slice(2, 14)}`;
        localStorage.setItem("roblox_fixed_hwid", hwid);
      }
      hwidInput.value = hwid;
    }

    function withParams(base, params){
      const u = new URL(base);
      Object.entries(params).forEach(([k,v]) => u.searchParams.set(k, v));
      return u.toString();
    }

    async function verifyStep1(){
      const robloxId = robloxIdInput.value.trim();
      const hwid = hwidInput.value.trim();
      const res = await fetch(`${WORKER_URL}/verify-ad?step=1&hwid=${encodeURIComponent(hwid)}&robloxId=${encodeURIComponent(robloxId)}`);
      const data = await res.json();
      return { ok: !!data.success, message: data.message || "" };
    }

    function openAdAndPoll(){
      const robloxId = robloxIdInput.value.trim();
      const hwid = hwidInput.value.trim();
      if(!robloxId) return;

      const finalUrl = withParams(LOOTLABS_URL, { hwid, robloxId });
      const w = window.open(finalUrl, "_blank");
      if(!w){
        showStatus("弹窗被拦截：请允许本站弹窗后再试", "error");
        return;
      }

      showStatus("已打开Step1广告页面，完成后自动检测…", "info");

      let poll = 0;
      const maxPoll = 60; // 3分钟
      const timer = setInterval(async () => {
        poll++;
        try{
          const r = await verifyStep1();
          if(r.ok){
            clearInterval(timer);
            step1Indicator.classList.add("completed");
            generateBtn.disabled = false;
            showStatus("Step1 验证成功！现在可以生成卡密。", "success");
          }else{
            if(poll >= maxPoll){
              clearInterval(timer);
              showStatus("检测超时：请确认广告已完成，然后再点一次 Step1。", "error");
            }
          }
        }catch(e){
          clearInterval(timer);
          showStatus("检测失败：" + e.message, "error");
        }
      }, 3000);
    }

    // 初始化
    window.onload = () => {
      initHWID();
      robloxIdInput.addEventListener("input", () => {
        const ok = !!robloxIdInput.value.trim();
        step1Btn.disabled = !ok;
        generateBtn.disabled = true;
        step1Indicator.classList.remove("completed");
        showStatus(ok ? "点击 Step1 开始验证" : "系统就绪，请先填写Roblox ID", "info");
      });
    };

    step1Btn.addEventListener("click", openAdAndPoll);

    generateBtn.addEventListener("click", async () => {
      const robloxId = robloxIdInput.value.trim();
      const hwid = hwidInput.value.trim();
      try{
        const res = await fetch(`${WORKER_URL}/generate-key`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ hwid, robloxId })
        });
        const data = await res.json();
        if(res.ok){
          document.getElementById("key").value = data.key;
          showStatus(`卡密生成成功：${data.key}\n过期时间：${new Date(data.expireTime).toLocaleString()}`, "success");
        }else{
          showStatus("生成失败：" + (data.message || "未知错误"), "error");
        }
      }catch(e){
        showStatus("生成失败：" + e.message, "error");
      }
    });

    verifyBtn.addEventListener("click", async () => {
      const robloxId = robloxIdInput.value.trim();
      const hwid = hwidInput.value.trim();
      const key = document.getElementById("key").value.trim();
      if(!robloxId || !key){
        showStatus("请填写 Roblox ID 和 卡密", "error");
        return;
      }
      try{
        const res = await fetch(`${WORKER_URL}/verify-key`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ key, robloxId, hwid })
        });
        const data = await res.json();
        showStatus(data.valid ? "卡密有效！" : ("无效：" + (data.message || "")), data.valid ? "success":"error");
      }catch(e){
        showStatus("验证失败：" + e.message, "error");
      }
    });
  </script>
</body>
</html>

