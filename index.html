<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Key System - 自动验证版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .guide-tip {
            background: #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        .step-container {
            display: none;
            background: #2d2d2d;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-container.active {
            display: block;
        }
        h1 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 22px;
        }
        a {
            display: inline-block;
            background: #3b82f6;
            color: #fff;
            padding: 12px 20px;
            border-radius: 6px;
            text-decoration: none;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        a:hover {
            background: #2563eb;
        }
        button {
            background: #10b981;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover {
            background: #059669;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        #key-display {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 18px;
            word-break: break-all;
            color: #4ade80;
            animation: fadeIn 0.3s ease;
        }
        .error-tip {
            color: #ef4444;
            margin-top: 10px;
            font-size: 14px;
        }
        .loading {
            color: #60a5fa;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .tip-text {
            color: #9ca3af;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- 操作指引 -->
    <div class="guide-tip">
        <strong>操作指引：</strong>点击广告链接完成任务后，页面会自动返回并校验，无需手动操作～
    </div>

    <!-- 步骤1：Lootslab广告 -->
    <div id="step1" class="step-container active">
        <h1>步骤1：完成Lootslab广告验证</h1>
        <a id="ad1-link" href="#" target="_blank">点击打开Lootslab广告</a>
        <p class="tip-text">完成广告后页面将自动返回并校验</p>
        <button onclick="checkStep(1)" style="display: none;">手动校验广告完成状态</button>
        <div class="loading" id="loading1">正在自动校验广告状态...</div>
        <div class="error-tip" id="error1"></div>
    </div>

    <!-- 步骤2：Linkvertise广告 -->
    <div id="step2" class="step-container">
        <h1>步骤2：完成Linkvertise广告验证</h1>
        <a id="ad2-link" href="#" target="_blank">点击打开Linkvertise广告</a>
        <p class="tip-text">完成广告后页面将自动返回并校验</p>
        <button onclick="checkStep(2)" style="display: none;">手动校验广告完成状态</button>
        <div class="loading" id="loading2">正在自动校验广告状态...</div>
        <div class="error-tip" id="error2"></div>
    </div>

    <!-- 步骤3：Linkvertise广告 -->
    <div id="step3" class="step-container">
        <h1>步骤3：完成Linkvertise广告验证</h1>
        <a id="ad3-link" href="#" target="_blank">点击打开Linkvertise广告</a>
        <p class="tip-text">完成广告后页面将自动返回并校验</p>
        <button onclick="checkStep(3)" style="display: none;">手动校验广告完成状态</button>
        <div class="loading" id="loading3">正在自动校验广告状态...</div>
        <div class="error-tip" id="error3"></div>
    </div>

    <!-- 卡密展示区域 -->
    <div id="key-display"></div>

    <script>
        // 配置项
        const WORKERS_URL = "https://r.check868.workers.dev"; // 你的Workers域名
        const LOOTSLAB_AD_URL = "https://lootdest.org/s?Li5EAgHB"; // 新的Lootslabs自动跳转链接
        const LINKVERTISE_AD2_URL = "你的Linkvertise Step2广告链接"; // 替换为实际链接
        const LINKVERTISE_AD3_URL = "你的Linkvertise Step3广告链接"; // 替换为实际链接
        const PAGES_URL = "https://zisandchuck.github.io"; // 前端页面域名

        // 获取URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const step = urlParams.get("step");
        const source = urlParams.get("source");
        const autoCheck = urlParams.get("autoCheck");
        const ROBLOX_ID = urlParams.get("robloxId") || "未知用户";

        // 初始化广告链接
        window.onload = function() {
            // Step1广告链接（带自动校验参数）
            const ad1FinalUrl = `${LOOTSLAB_AD_URL}&callback=${PAGES_URL}?step=1&source=step1&autoCheck=1`;
            document.getElementById("ad1-link").href = ad1FinalUrl;

            // Step2广告链接
            const ad2FinalUrl = `${LINKVERTISE_AD2_URL}&callback=${PAGES_URL}?step=2&source=step2&autoCheck=1`;
            document.getElementById("ad2-link").href = ad2FinalUrl;

            // Step3广告链接
            const ad3FinalUrl = `${LINKVERTISE_AD3_URL}&callback=${PAGES_URL}?step=3&source=step3&autoCheck=1`;
            document.getElementById("ad3-link").href = ad3FinalUrl;

            // 自动校验逻辑
            if (step && source && autoCheck === "1" && source === `step${step}`) {
                const stepNum = parseInt(step);
                document.getElementById(`loading${stepNum}`).style.display = "block";
                // 延迟1秒校验，确保广告状态同步
                setTimeout(() => {
                    checkStep(stepNum, true);
                }, 1000);
            }
        };

        // 获取设备HWID
        function getHWID() {
            if (localStorage.getItem("hwid")) {
                return localStorage.getItem("hwid");
            }
            const hwid = Math.random().toString(36).slice(2, 18) + Date.now().toString(36);
            localStorage.setItem("hwid", hwid);
            return hwid;
        }

        // 校验广告完成状态
        async function checkStep(step, isAuto = false) {
            const hwid = getHWID();
            const loadingEl = document.getElementById(`loading${step}`);
            const errorEl = document.getElementById(`error${step}`);
            
            errorEl.textContent = "";
            if (!isAuto) loadingEl.style.display = "block";

            try {
                const response = await fetch(`${WORKERS_URL}/verify-ad?step=${step}&hwid=${hwid}&robloxId=${ROBLOX_ID}`, {
                    headers: {
                        "Referer": isAuto ? (step === 1 ? LOOTSLAB_AD_URL : LINKVERTISE_AD2_URL) : PAGES_URL
                    }
                });
                const result = await response.text();
                loadingEl.style.display = "none";

                if (response.ok) {
                    if (step === 3) {
                        generateKey();
                    } else {
                        document.getElementById(`step${step}`).classList.remove("active");
                        document.getElementById(`step${step+1}`).classList.add("active");
                        window.scrollTo(0, 0);
                        if (isAuto) alert(`Step${step}广告验证成功，已跳转到Step${step+1}`);
                    }
                } else if (response.status === 403) {
                    errorEl.textContent = "验证失败：非法访问，需从广告页面跳转";
                } else {
                    errorEl.textContent = `验证失败：${result}`;
                    // 显示手动校验按钮
                    document.querySelector(`#step${step} button`).style.display = "inline-block";
                }
            } catch (err) {
                loadingEl.style.display = "none";
                errorEl.textContent = `网络错误：${err.message}`;
                document.querySelector(`#step${step} button`).style.display = "inline-block";
            }
        }

        // 生成卡密
        async function generateKey() {
            const hwid = getHWID();
            const keyDisplay = document.getElementById("key-display");
            keyDisplay.textContent = "正在生成卡密...";

            try {
                const response = await fetch(`${WORKERS_URL}/generate-key`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        hwid: hwid,
                        robloxId: ROBLOX_ID
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    keyDisplay.innerHTML = `
                        <h2>卡密生成成功！</h2>
                        <p>你的卡密（12小时内有效）：</p>
                        <strong style="font-size: 20px; letter-spacing: 1px;">${data.key}</strong>
                        <p style="margin-top: 10px;">卡密仅可使用一次，有效期12小时</p>
                        <p style="margin-top: 5px; color: #9ca3af;">复制卡密返回Roblox完成验证</p>
                    `;
                    document.querySelectorAll(".step-container").forEach(el => el.style.display = "none");
                } else {
                    keyDisplay.textContent = `生成失败：${data.message || "请完成所有广告步骤"}`;
                }
            } catch (err) {
                keyDisplay.textContent = `生成失败：${err.message}`;
            }
        }
    </script>
</body>
</html>

